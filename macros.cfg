#  ___  ___  ___  _____ ______ _____ _
#  |  \/  | / _ \/  __ \| ___ \  _  ( )
#  | .  . |/ /_\ \ /  \/| |_/ / | | |/ ___
#  | |\/| ||  _  | |    |    /| | | | / __|
#  | |  | || | | | \__/\| |\ \\ \_/ / \__ \
#  \_|  |_/\_| |_/\____/\_| \_|\___/  |___/
#

# # # # # # # # # # # # # # # # # # #
# Printer start and stop
# # # # # # # # # # # # # # # # # # #
#
#  !!
# For this to work in Slic3r or it's forks, I use SuperSlicer you must have
# M104 S[first_layer_temperature]       ; set extruder temp
# M140 S[first_layer_bed_temperature]   ; set bed temp
# in the start G-code of your printer before you call this macro.
#
# This seems to be fixed in Superslicer 2.2.53.x but that version
# will not compile on my system because of a bug in BOOST. Arch version
# of BOOST is 1.72 at this moment and the fixed version is 1.73.
#
# Slic3r: enable relative E distances printer settings
#
# I do not use Cura, but I guess for this to work with Cura,
# you have to have Relative Extrusion enabled.
# Cura: enable relative Extrusion in the Special modes tab of the print settings.
#

[gcode_macro START_PRINT]
gcode:
  G21 					                      # metric values
  G90 					                      # absolute positioning
  M82 					                      # set extruder to absolute mode
  BED_MESH_PROFILE LOAD=COLD_BED         # Load bed profile
  SKEW_PROFILE LOAD=my_skew_profile      # Load skew profile
  M220 S100                              # Reset speed
 # M190 S[BED_TEMP]			                 # Wait for bed to reach temperature
 # M109 S[EXTRUDER_TEMP]			            # Set and wait for nozzle to reach temperature
  G28 					                       # home all axes
  G1 Y0 F3000 				                # bring extruder to the front
  G92 E0 				                      # zero the extruded length
  G28 Z 				                      # Home Z
  G1 Z20 F3000 				                # lower
  G1 E20 F100 				                # purge nozzle quickly
  G1 Y15 F3000 				                # bring extruder to the front
  G1 E25 F50 				                  # purge nozzle slowly
  G92 E0 				                    # zero the extruded length again
  G1 Y190 Z0.2  F9000 			          # pull away filament
  G1 X125 E12 F600 			            # move x-carriage 100mm while extruding
  G1 F9000				                    # set movement speed
  G92 E0				                  # absolute positioning

[gcode_macro END_PRINT]
gcode:
  M104 S0 				# extruder heater off
  M140 S0 				# heated bed heater off (if you have it)
  G91 					# relative positioning
  G1 E-1 F300  				# retract the filament a bit before lifting the nozzle, to release some of the pressure
  G1 Z+0.5 E-1 X-20 Y-20 F9000 		# move Z up a bit and retract filament even more
  G28 Z0 				# move Z to min endstops, so the head is out of the way
  G28 X0 Y0				# move X/Y to min endstops
  M84 					# steppers off
  G90 					# absolute positioning
  SET_SKEW CLEAR=1			# clear skew profile

  
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 0    #edit to your park position
default_parameter_Y: 0    #edit to your park position
default_parameter_Z: 10     #edit to your park position
default_parameter_E: 8      #edit to your retract length
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000
    
[gcode_macro RESUME]
rename_existing: BASE_RESUME
default_parameter_E: 8      #edit to your retract length
gcode:
    G91
    G1 E{E} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME
    
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

# # # # # # # # # # # # # # # # # # #
# Bed leveling
# # # # # # # # # # # # # # # # # # #

[gcode_macro G29]
gcode:
  G28                                # Home all axes
  BED_MESH_CALIBRATE                 # Calibrate Bed
  G0  X0 Y0 F12000                   # Move nozzle to home position
  SAVE_CONFIG                        # Saven bed mesh to printer.cfg

# # # # # # # # # # # # # # # # # # #
# Tool change and selection
# # # # # # # # # # # # # # # # # # #

[gcode_macro loadExtruder]
gcode:
  M109 S220
  M117 Loading extruder....           # Message on display
  M83                                 # Relative moves for extruder
  G92 E0                              # Set the current filament position to E=0
  G1 F700 E60                         # Extrude 60 mm to fill the splitte
  G92 E0                              # Set the current filament position to E=0
  G1 F200 E55                         # Extrude 55 mm to purge the nozzle
  G92 E0                              # Set the current filament position to E=0
  G92 E0                              # Set the current filament position to E=0
  G28                                 # Home to signal it finished pushing filament

[gcode_macro unloadExtruder]
gcode:
  M109 S220
  M117 Unloading extruder....         # Message on display
  M83                                 # Relative moves for extruder
  G92 E0                              # Set the current filament position to E=0
  G1 X0 Y0 F12000                     # Park head at home position
  G92 E0                              # Set the current filament position to E=0
  G1 F700 E5                          # Reinsert 5mm to prevent stringing
  G92 E0                              # Set the current filament position to E=0
  G1 F1300 E-150                      # Quickly retract 150 mm to free the splitter
  M84 E                               # Release extruder from 'holding' position
	
[gcode_macro PREHEAT_ABS_BED]
gcode:
    M140 S90					; preheat BED
    
[gcode_macro COOLDOWN]
gcode:
    M140 S0						; preheat BED
    M104 S0    					; preheat Tool

[gcode_macro POWER_OFF_PRINTER]
gcode:
  {action_call_remote_method("set_device_power",
                             device="printer",
                             state="off")}

[gcode_macro REMOVE_PART]
gcode:
    G91
    G1 Z-50 F5000
    G90

[delayed_gcode delayed_printer_off]
initial_duration: 0.
gcode:
  {% if printer.idle_timeout.state == "Idle" %}
    POWER_OFF_PRINTER
  {% endif %}